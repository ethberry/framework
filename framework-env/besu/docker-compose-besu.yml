version: "3.3"

services:

  besu-test:
    container_name: besu-test
    user: root
    restart: "on-failure"
    image: hyperledger/besu:latest
    environment:
      BESU_GENESIS_FILE: /var/lib/besu/gen-besu.json
      BESU_DATA_PATH: /var/lib/besu
      BESU_HOST_ALLOWLIST: "*"
      BESU_RPC_WS_ENABLED: "true"
      BESU_RPC_WS_HOST: 0.0.0.0
      BESU_RPC_HTTP_HOST: 0.0.0.0
      BESU_RPC_HTTP_ENABLED: "true"
      BESU_RPC_HTTP_CORS_ORIGINS: "*"
      BESU_RPC_HTTP_API: "ADMIN,ETH,NET,WEB3,MINER,IBFT"
      BESU_RPC_WS_API: "ADMIN,ETH,NET,WEB3,MINER,IBFT"
      BESU_MINER_ENABLED: "true"
      BESU_MINER_COINBASE: fe3b557e8fb62b89f4916b721be55ceb828dbd73
    volumes:
      - ${BASE_PATH}/besu:/var/lib/besu
      - ${BASE_PATH}/gen-besu-mm.json:/var/lib/besu/gen-besu.json
    ports:
      - "8545:8545"
      - "8546:8546"
      - "8547:8547"
      - "30303:30303"

  besu-explorer:
    container_name: besu-explorer
    restart: "on-failure"
    image: alethio/ethereum-lite-explorer
    environment:
      APP_NODE_URL: "${JSON_RPC_ADDR}"
    ports:
      - "${PORT_EXPL_API}:80"
    depends_on:
      - besu-test

  nginx:
    container_name: nginx
    image: nginx
    volumes:
      - ./nginx/admin.besu.conf:/etc/nginx/conf.d/admin.conf
      - ./nginx/log:/var/log/nginx/
    ports:
      - "80:80"
      - "443:443"
      - "1337:1337"
    depends_on:
      - besu-test
      - besu-explorer
